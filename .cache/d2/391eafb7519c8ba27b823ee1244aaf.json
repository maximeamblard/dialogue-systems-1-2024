{"id":"../node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/WebsocketMessageAdapter.js","dependencies":[{"name":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/WebsocketMessageAdapter.js.map","includedInParent":true,"mtime":1733074701821},{"name":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/package.json","includedInParent":true,"mtime":1733076065657},{"name":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/package.json","includedInParent":true,"mtime":1733074701821},{"name":"ws","loc":{"line":46,"column":35,"index":2911},"parent":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/WebsocketMessageAdapter.js","resolved":"/Users/amblardv5/.nvm/versions/node/v22.11.0/lib/node_modules/parcel-bundler/src/builtins/_empty.js"},{"name":"../common.speech/HeaderNames","loc":{"line":47,"column":28,"index":2947},"parent":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/WebsocketMessageAdapter.js","resolved":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.speech/HeaderNames.js"},{"name":"../common/Exports","loc":{"line":48,"column":24,"index":3004},"parent":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/WebsocketMessageAdapter.js","resolved":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common/Exports.js"},{"name":"./CertChecks","loc":{"line":49,"column":27,"index":3053},"parent":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/WebsocketMessageAdapter.js","resolved":"/Users/amblardv5/Nextcloud/2024/dialogue-systems-1-2024/node_modules/microsoft-cognitiveservices-speech-sdk/distrib/lib/src/common.browser/CertChecks.js"}],"generated":{"js":"\"use strict\";\n// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT license.\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WebsocketMessageAdapter = void 0;\n// Node.JS specific web socket / browser support.\nvar ws_1 = __importDefault(require(\"ws\"));\nvar HeaderNames_1 = require(\"../common.speech/HeaderNames\");\nvar Exports_1 = require(\"../common/Exports\");\nvar CertChecks_1 = require(\"./CertChecks\");\nvar WebsocketMessageAdapter = /** @class */ (function () {\n    function WebsocketMessageAdapter(uri, connectionId, messageFormatter, proxyInfo, headers, enableCompression) {\n        if (!uri) {\n            throw new Exports_1.ArgumentNullError(\"uri\");\n        }\n        if (!messageFormatter) {\n            throw new Exports_1.ArgumentNullError(\"messageFormatter\");\n        }\n        this.proxyInfo = proxyInfo;\n        this.privConnectionEvents = new Exports_1.EventSource();\n        this.privConnectionId = connectionId;\n        this.privMessageFormatter = messageFormatter;\n        this.privConnectionState = Exports_1.ConnectionState.None;\n        this.privUri = uri;\n        this.privHeaders = headers;\n        this.privEnableCompression = enableCompression;\n        // Add the connection ID to the headers\n        this.privHeaders[HeaderNames_1.HeaderNames.ConnectionId] = this.privConnectionId;\n        this.privLastErrorReceived = \"\";\n    }\n    Object.defineProperty(WebsocketMessageAdapter.prototype, \"state\", {\n        get: function () {\n            return this.privConnectionState;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    WebsocketMessageAdapter.prototype.open = function () {\n        var _this = this;\n        if (this.privConnectionState === Exports_1.ConnectionState.Disconnected) {\n            return Promise.reject(\"Cannot open a connection that is in \" + this.privConnectionState + \" state\");\n        }\n        if (this.privConnectionEstablishDeferral) {\n            return this.privConnectionEstablishDeferral.promise;\n        }\n        this.privConnectionEstablishDeferral = new Exports_1.Deferred();\n        this.privCertificateValidatedDeferral = new Exports_1.Deferred();\n        this.privConnectionState = Exports_1.ConnectionState.Connecting;\n        try {\n            if (typeof WebSocket !== \"undefined\" && !WebsocketMessageAdapter.forceNpmWebSocket) {\n                // Browser handles cert checks.\n                this.privCertificateValidatedDeferral.resolve();\n                this.privWebsocketClient = new WebSocket(this.privUri);\n            }\n            else {\n                var options = { headers: this.privHeaders, perMessageDeflate: this.privEnableCompression };\n                // The ocsp library will handle validation for us and fail the connection if needed.\n                this.privCertificateValidatedDeferral.resolve();\n                var checkAgent = new CertChecks_1.CertCheckAgent(this.proxyInfo);\n                options.agent = checkAgent.GetAgent();\n                // Workaround for https://github.com/microsoft/cognitive-services-speech-sdk-js/issues/465\n                // Which is root caused by https://github.com/TooTallNate/node-agent-base/issues/61\n                var uri = new URL(this.privUri);\n                var protocol = uri.protocol;\n                if ((protocol === null || protocol === void 0 ? void 0 : protocol.toLocaleLowerCase()) === \"wss:\") {\n                    protocol = \"https:\";\n                }\n                else if ((protocol === null || protocol === void 0 ? void 0 : protocol.toLocaleLowerCase()) === \"ws:\") {\n                    protocol = \"http:\";\n                }\n                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n                options.agent.protocol = protocol;\n                this.privWebsocketClient = new ws_1.default(this.privUri, options);\n            }\n            this.privWebsocketClient.binaryType = \"arraybuffer\";\n            this.privReceivingMessageQueue = new Exports_1.Queue();\n            this.privDisconnectDeferral = new Exports_1.Deferred();\n            this.privSendMessageQueue = new Exports_1.Queue();\n            this.processSendQueue().catch(function (reason) {\n                Exports_1.Events.instance.onEvent(new Exports_1.BackgroundEvent(reason));\n            });\n        }\n        catch (error) {\n            this.privConnectionEstablishDeferral.resolve(new Exports_1.ConnectionOpenResponse(500, error));\n            return this.privConnectionEstablishDeferral.promise;\n        }\n        this.onEvent(new Exports_1.ConnectionStartEvent(this.privConnectionId, this.privUri));\n        this.privWebsocketClient.onopen = function () {\n            _this.privCertificateValidatedDeferral.promise.then(function () {\n                _this.privConnectionState = Exports_1.ConnectionState.Connected;\n                _this.onEvent(new Exports_1.ConnectionEstablishedEvent(_this.privConnectionId));\n                _this.privConnectionEstablishDeferral.resolve(new Exports_1.ConnectionOpenResponse(200, \"\"));\n            }, function (error) {\n                _this.privConnectionEstablishDeferral.reject(error);\n            });\n        };\n        this.privWebsocketClient.onerror = function (e) {\n            _this.onEvent(new Exports_1.ConnectionErrorEvent(_this.privConnectionId, e.message, e.type));\n            _this.privLastErrorReceived = e.message;\n        };\n        this.privWebsocketClient.onclose = function (e) {\n            if (_this.privConnectionState === Exports_1.ConnectionState.Connecting) {\n                _this.privConnectionState = Exports_1.ConnectionState.Disconnected;\n                // this.onEvent(new ConnectionEstablishErrorEvent(this.connectionId, e.code, e.reason));\n                _this.privConnectionEstablishDeferral.resolve(new Exports_1.ConnectionOpenResponse(e.code, e.reason + \" \" + _this.privLastErrorReceived));\n            }\n            else {\n                _this.privConnectionState = Exports_1.ConnectionState.Disconnected;\n                _this.privWebsocketClient = null;\n                _this.onEvent(new Exports_1.ConnectionClosedEvent(_this.privConnectionId, e.code, e.reason));\n            }\n            _this.onClose(e.code, e.reason).catch(function (reason) {\n                Exports_1.Events.instance.onEvent(new Exports_1.BackgroundEvent(reason));\n            });\n        };\n        this.privWebsocketClient.onmessage = function (e) {\n            var networkReceivedTime = new Date().toISOString();\n            if (_this.privConnectionState === Exports_1.ConnectionState.Connected) {\n                var deferred_1 = new Exports_1.Deferred();\n                // let id = ++this.idCounter;\n                _this.privReceivingMessageQueue.enqueueFromPromise(deferred_1.promise);\n                if (e.data instanceof ArrayBuffer) {\n                    var rawMessage = new Exports_1.RawWebsocketMessage(Exports_1.MessageType.Binary, e.data);\n                    _this.privMessageFormatter\n                        .toConnectionMessage(rawMessage)\n                        .then(function (connectionMessage) {\n                        _this.onEvent(new Exports_1.ConnectionMessageReceivedEvent(_this.privConnectionId, networkReceivedTime, connectionMessage));\n                        deferred_1.resolve(connectionMessage);\n                    }, function (error) {\n                        // TODO: Events for these ?\n                        deferred_1.reject(\"Invalid binary message format. Error: \" + error);\n                    });\n                }\n                else {\n                    var rawMessage = new Exports_1.RawWebsocketMessage(Exports_1.MessageType.Text, e.data);\n                    _this.privMessageFormatter\n                        .toConnectionMessage(rawMessage)\n                        .then(function (connectionMessage) {\n                        _this.onEvent(new Exports_1.ConnectionMessageReceivedEvent(_this.privConnectionId, networkReceivedTime, connectionMessage));\n                        deferred_1.resolve(connectionMessage);\n                    }, function (error) {\n                        // TODO: Events for these ?\n                        deferred_1.reject(\"Invalid text message format. Error: \" + error);\n                    });\n                }\n            }\n        };\n        return this.privConnectionEstablishDeferral.promise;\n    };\n    WebsocketMessageAdapter.prototype.send = function (message) {\n        if (this.privConnectionState !== Exports_1.ConnectionState.Connected) {\n            return Promise.reject(\"Cannot send on connection that is in \" + Exports_1.ConnectionState[this.privConnectionState] + \" state\");\n        }\n        var messageSendStatusDeferral = new Exports_1.Deferred();\n        var messageSendDeferral = new Exports_1.Deferred();\n        this.privSendMessageQueue.enqueueFromPromise(messageSendDeferral.promise);\n        this.privMessageFormatter\n            .fromConnectionMessage(message)\n            .then(function (rawMessage) {\n            messageSendDeferral.resolve({\n                Message: message,\n                RawWebsocketMessage: rawMessage,\n                sendStatusDeferral: messageSendStatusDeferral,\n            });\n        }, function (error) {\n            messageSendDeferral.reject(\"Error formatting the message. \" + error);\n        });\n        return messageSendStatusDeferral.promise;\n    };\n    WebsocketMessageAdapter.prototype.read = function () {\n        if (this.privConnectionState !== Exports_1.ConnectionState.Connected) {\n            return Promise.reject(\"Cannot read on connection that is in \" + this.privConnectionState + \" state\");\n        }\n        return this.privReceivingMessageQueue.dequeue();\n    };\n    WebsocketMessageAdapter.prototype.close = function (reason) {\n        if (this.privWebsocketClient) {\n            if (this.privConnectionState !== Exports_1.ConnectionState.Disconnected) {\n                this.privWebsocketClient.close(1000, reason ? reason : \"Normal closure by client\");\n            }\n        }\n        else {\n            return Promise.resolve();\n        }\n        return this.privDisconnectDeferral.promise;\n    };\n    Object.defineProperty(WebsocketMessageAdapter.prototype, \"events\", {\n        get: function () {\n            return this.privConnectionEvents;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    WebsocketMessageAdapter.prototype.sendRawMessage = function (sendItem) {\n        try {\n            // indicates we are draining the queue and it came with no message;\n            if (!sendItem) {\n                return Promise.resolve();\n            }\n            this.onEvent(new Exports_1.ConnectionMessageSentEvent(this.privConnectionId, new Date().toISOString(), sendItem.Message));\n            // add a check for the ws readystate in order to stop the red console error 'WebSocket is already in CLOSING or CLOSED state' appearing\n            if (this.isWebsocketOpen) {\n                // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n                this.privWebsocketClient.send(sendItem.RawWebsocketMessage.payload);\n            }\n            else {\n                return Promise.reject(\"websocket send error: Websocket not ready \" + this.privConnectionId + \" \" + sendItem.Message.id + \" \" + new Error().stack);\n            }\n            return Promise.resolve();\n        }\n        catch (e) {\n            return Promise.reject(\"websocket send error: \" + e);\n        }\n    };\n    WebsocketMessageAdapter.prototype.onClose = function (code, reason) {\n        return __awaiter(this, void 0, void 0, function () {\n            var closeReason;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        closeReason = \"Connection closed. \" + code + \": \" + reason;\n                        this.privConnectionState = Exports_1.ConnectionState.Disconnected;\n                        this.privDisconnectDeferral.resolve();\n                        return [4 /*yield*/, this.privReceivingMessageQueue.drainAndDispose(function () {\n                                // TODO: Events for these ?\n                                // Logger.instance.onEvent(new LoggingEvent(LogType.Warning, null, `Failed to process received message. Reason: ${closeReason}, Message: ${JSON.stringify(pendingReceiveItem)}`));\n                            }, closeReason)];\n                    case 1:\n                        _a.sent();\n                        return [4 /*yield*/, this.privSendMessageQueue.drainAndDispose(function (pendingSendItem) {\n                                pendingSendItem.sendStatusDeferral.reject(closeReason);\n                            }, closeReason)];\n                    case 2:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WebsocketMessageAdapter.prototype.processSendQueue = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var itemToSend, sendItem, sendError_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!true) return [3 /*break*/, 6];\n                        itemToSend = this.privSendMessageQueue.dequeue();\n                        return [4 /*yield*/, itemToSend];\n                    case 1:\n                        sendItem = _a.sent();\n                        // indicates we are draining the queue and it came with no message;\n                        if (!sendItem) {\n                            return [2 /*return*/];\n                        }\n                        _a.label = 2;\n                    case 2:\n                        _a.trys.push([2, 4, , 5]);\n                        return [4 /*yield*/, this.sendRawMessage(sendItem)];\n                    case 3:\n                        _a.sent();\n                        sendItem.sendStatusDeferral.resolve();\n                        return [3 /*break*/, 5];\n                    case 4:\n                        sendError_1 = _a.sent();\n                        sendItem.sendStatusDeferral.reject(sendError_1);\n                        return [3 /*break*/, 5];\n                    case 5: return [3 /*break*/, 0];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    WebsocketMessageAdapter.prototype.onEvent = function (event) {\n        this.privConnectionEvents.onEvent(event);\n        Exports_1.Events.instance.onEvent(event);\n    };\n    Object.defineProperty(WebsocketMessageAdapter.prototype, \"isWebsocketOpen\", {\n        get: function () {\n            return this.privWebsocketClient && this.privWebsocketClient.readyState === this.privWebsocketClient.OPEN;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    WebsocketMessageAdapter.forceNpmWebSocket = false;\n    return WebsocketMessageAdapter;\n}());\nexports.WebsocketMessageAdapter = WebsocketMessageAdapter;\n\n\n"},"sourceMaps":{"js":{"version":3,"sources":["src/common.browser/WebsocketMessageAdapter.ts"],"names":[],"mappings":"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","file":"WebsocketMessageAdapter.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT license.\r\n\r\n// Node.JS specific web socket / browser support.\r\nimport ws from \"ws\";\r\nimport { HeaderNames } from \"../common.speech/HeaderNames\";\r\nimport {\r\n    ArgumentNullError,\r\n    BackgroundEvent,\r\n    ConnectionClosedEvent,\r\n    ConnectionErrorEvent,\r\n    ConnectionEstablishedEvent,\r\n    ConnectionEvent,\r\n    ConnectionMessage,\r\n    ConnectionMessageReceivedEvent,\r\n    ConnectionMessageSentEvent,\r\n    ConnectionOpenResponse,\r\n    ConnectionStartEvent,\r\n    ConnectionState,\r\n    Deferred,\r\n    Events,\r\n    EventSource,\r\n    IWebsocketMessageFormatter,\r\n    MessageType,\r\n    Queue,\r\n    RawWebsocketMessage,\r\n} from \"../common/Exports\";\r\nimport { ProxyInfo } from \"./ProxyInfo\";\r\n\r\nimport { CertCheckAgent } from \"./CertChecks\";\r\n\r\ninterface ISendItem {\r\n    Message: ConnectionMessage;\r\n    RawWebsocketMessage: RawWebsocketMessage;\r\n    sendStatusDeferral: Deferred<void>;\r\n}\r\n\r\nexport class WebsocketMessageAdapter {\r\n    private privConnectionState: ConnectionState;\r\n    private privMessageFormatter: IWebsocketMessageFormatter;\r\n    private privWebsocketClient: WebSocket | ws;\r\n\r\n    private privSendMessageQueue: Queue<ISendItem>;\r\n    private privReceivingMessageQueue: Queue<ConnectionMessage>;\r\n    private privConnectionEstablishDeferral: Deferred<ConnectionOpenResponse>;\r\n    private privCertificateValidatedDeferral: Deferred<void>;\r\n    private privDisconnectDeferral: Deferred<void>;\r\n    private privConnectionEvents: EventSource<ConnectionEvent>;\r\n    private privConnectionId: string;\r\n    private privUri: string;\r\n    private proxyInfo: ProxyInfo;\r\n    private privHeaders: { [key: string]: string };\r\n    private privLastErrorReceived: string;\r\n    private privEnableCompression: boolean;\r\n\r\n    public static forceNpmWebSocket: boolean = false;\r\n\r\n    public constructor(\r\n        uri: string,\r\n        connectionId: string,\r\n        messageFormatter: IWebsocketMessageFormatter,\r\n        proxyInfo: ProxyInfo,\r\n        headers: { [key: string]: string },\r\n        enableCompression: boolean) {\r\n\r\n        if (!uri) {\r\n            throw new ArgumentNullError(\"uri\");\r\n        }\r\n\r\n        if (!messageFormatter) {\r\n            throw new ArgumentNullError(\"messageFormatter\");\r\n        }\r\n\r\n        this.proxyInfo = proxyInfo;\r\n        this.privConnectionEvents = new EventSource<ConnectionEvent>();\r\n        this.privConnectionId = connectionId;\r\n        this.privMessageFormatter = messageFormatter;\r\n        this.privConnectionState = ConnectionState.None;\r\n        this.privUri = uri;\r\n        this.privHeaders = headers;\r\n        this.privEnableCompression = enableCompression;\r\n\r\n        // Add the connection ID to the headers\r\n        this.privHeaders[HeaderNames.ConnectionId] = this.privConnectionId;\r\n\r\n        this.privLastErrorReceived = \"\";\r\n    }\r\n\r\n    public get state(): ConnectionState {\r\n        return this.privConnectionState;\r\n    }\r\n\r\n    public open(): Promise<ConnectionOpenResponse> {\r\n        if (this.privConnectionState === ConnectionState.Disconnected) {\r\n            return Promise.reject<ConnectionOpenResponse>(`Cannot open a connection that is in ${this.privConnectionState} state`);\r\n        }\r\n\r\n        if (this.privConnectionEstablishDeferral) {\r\n            return this.privConnectionEstablishDeferral.promise;\r\n        }\r\n\r\n        this.privConnectionEstablishDeferral = new Deferred<ConnectionOpenResponse>();\r\n        this.privCertificateValidatedDeferral = new Deferred<void>();\r\n\r\n        this.privConnectionState = ConnectionState.Connecting;\r\n\r\n        try {\r\n\r\n            if (typeof WebSocket !== \"undefined\" && !WebsocketMessageAdapter.forceNpmWebSocket) {\r\n                // Browser handles cert checks.\r\n                this.privCertificateValidatedDeferral.resolve();\r\n\r\n                this.privWebsocketClient = new WebSocket(this.privUri);\r\n            } else {\r\n                const options: ws.ClientOptions = { headers: this.privHeaders, perMessageDeflate: this.privEnableCompression };\r\n                // The ocsp library will handle validation for us and fail the connection if needed.\r\n                this.privCertificateValidatedDeferral.resolve();\r\n                const checkAgent: CertCheckAgent = new CertCheckAgent(this.proxyInfo);\r\n\r\n                options.agent = checkAgent.GetAgent();\r\n\r\n                // Workaround for https://github.com/microsoft/cognitive-services-speech-sdk-js/issues/465\r\n                // Which is root caused by https://github.com/TooTallNate/node-agent-base/issues/61\r\n                const uri = new URL(this.privUri);\r\n                let protocol: string = uri.protocol;\r\n\r\n                if (protocol?.toLocaleLowerCase() === \"wss:\") {\r\n                    protocol = \"https:\";\r\n                } else if (protocol?.toLocaleLowerCase() === \"ws:\") {\r\n                    protocol = \"http:\";\r\n                }\r\n                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\r\n                (options.agent as any).protocol = protocol;\r\n                this.privWebsocketClient = new ws(this.privUri, options);\r\n            }\r\n\r\n            this.privWebsocketClient.binaryType = \"arraybuffer\";\r\n            this.privReceivingMessageQueue = new Queue<ConnectionMessage>();\r\n            this.privDisconnectDeferral = new Deferred<void>();\r\n            this.privSendMessageQueue = new Queue<ISendItem>();\r\n            this.processSendQueue().catch((reason: string): void => {\r\n                Events.instance.onEvent(new BackgroundEvent(reason));\r\n            });\r\n        } catch (error) {\r\n            this.privConnectionEstablishDeferral.resolve(new ConnectionOpenResponse(500, error as string));\r\n            return this.privConnectionEstablishDeferral.promise;\r\n        }\r\n\r\n        this.onEvent(new ConnectionStartEvent(this.privConnectionId, this.privUri));\r\n\r\n        this.privWebsocketClient.onopen = (): void => {\r\n            this.privCertificateValidatedDeferral.promise.then((): void => {\r\n                this.privConnectionState = ConnectionState.Connected;\r\n                this.onEvent(new ConnectionEstablishedEvent(this.privConnectionId));\r\n                this.privConnectionEstablishDeferral.resolve(new ConnectionOpenResponse(200, \"\"));\r\n            }, (error: string): void => {\r\n                this.privConnectionEstablishDeferral.reject(error);\r\n            });\r\n        };\r\n\r\n        this.privWebsocketClient.onerror = (e: { error: any; message: string; type: string; target: WebSocket | ws }): void => {\r\n            this.onEvent(new ConnectionErrorEvent(this.privConnectionId, e.message, e.type));\r\n            this.privLastErrorReceived = e.message;\r\n        };\r\n\r\n        this.privWebsocketClient.onclose = (e: { wasClean: boolean; code: number; reason: string; target: WebSocket | ws }): void => {\r\n            if (this.privConnectionState === ConnectionState.Connecting) {\r\n                this.privConnectionState = ConnectionState.Disconnected;\r\n                // this.onEvent(new ConnectionEstablishErrorEvent(this.connectionId, e.code, e.reason));\r\n                this.privConnectionEstablishDeferral.resolve(new ConnectionOpenResponse(e.code, e.reason + \" \" + this.privLastErrorReceived));\r\n            } else {\r\n                this.privConnectionState = ConnectionState.Disconnected;\r\n                this.privWebsocketClient = null;\r\n                this.onEvent(new ConnectionClosedEvent(this.privConnectionId, e.code, e.reason));\r\n            }\r\n\r\n            this.onClose(e.code, e.reason).catch((reason: string): void => {\r\n                Events.instance.onEvent(new BackgroundEvent(reason));\r\n            });\r\n        };\r\n\r\n        this.privWebsocketClient.onmessage = (e: { data: ws.Data; type: string; target: WebSocket | ws }): void => {\r\n            const networkReceivedTime = new Date().toISOString();\r\n            if (this.privConnectionState === ConnectionState.Connected) {\r\n                const deferred = new Deferred<ConnectionMessage>();\r\n                // let id = ++this.idCounter;\r\n                this.privReceivingMessageQueue.enqueueFromPromise(deferred.promise);\r\n                if (e.data instanceof ArrayBuffer) {\r\n                    const rawMessage = new RawWebsocketMessage(MessageType.Binary, e.data);\r\n                    this.privMessageFormatter\r\n                        .toConnectionMessage(rawMessage)\r\n                        .then((connectionMessage: ConnectionMessage): void => {\r\n                            this.onEvent(new ConnectionMessageReceivedEvent(this.privConnectionId, networkReceivedTime, connectionMessage));\r\n                            deferred.resolve(connectionMessage);\r\n                        }, (error: string): void => {\r\n                            // TODO: Events for these ?\r\n                            deferred.reject(`Invalid binary message format. Error: ${error}`);\r\n                        });\r\n                } else {\r\n                    const rawMessage = new RawWebsocketMessage(MessageType.Text, e.data);\r\n                    this.privMessageFormatter\r\n                        .toConnectionMessage(rawMessage)\r\n                        .then((connectionMessage: ConnectionMessage): void => {\r\n                            this.onEvent(new ConnectionMessageReceivedEvent(this.privConnectionId, networkReceivedTime, connectionMessage));\r\n                            deferred.resolve(connectionMessage);\r\n                        }, (error: string): void => {\r\n                            // TODO: Events for these ?\r\n                            deferred.reject(`Invalid text message format. Error: ${error}`);\r\n                        });\r\n                }\r\n            }\r\n        };\r\n\r\n        return this.privConnectionEstablishDeferral.promise;\r\n    }\r\n\r\n    public send(message: ConnectionMessage): Promise<void> {\r\n        if (this.privConnectionState !== ConnectionState.Connected) {\r\n            return Promise.reject(`Cannot send on connection that is in ${ConnectionState[this.privConnectionState]} state`);\r\n        }\r\n\r\n        const messageSendStatusDeferral = new Deferred<void>();\r\n        const messageSendDeferral = new Deferred<ISendItem>();\r\n\r\n        this.privSendMessageQueue.enqueueFromPromise(messageSendDeferral.promise);\r\n\r\n        this.privMessageFormatter\r\n            .fromConnectionMessage(message)\r\n            .then((rawMessage: RawWebsocketMessage): void => {\r\n                messageSendDeferral.resolve({\r\n                    Message: message,\r\n                    RawWebsocketMessage: rawMessage,\r\n                    sendStatusDeferral: messageSendStatusDeferral,\r\n                });\r\n            }, (error: string): void => {\r\n                messageSendDeferral.reject(`Error formatting the message. ${error}`);\r\n            });\r\n\r\n        return messageSendStatusDeferral.promise;\r\n    }\r\n\r\n    public read(): Promise<ConnectionMessage> {\r\n        if (this.privConnectionState !== ConnectionState.Connected) {\r\n            return Promise.reject<ConnectionMessage>(`Cannot read on connection that is in ${this.privConnectionState} state`);\r\n        }\r\n\r\n        return this.privReceivingMessageQueue.dequeue();\r\n    }\r\n\r\n    public close(reason?: string): Promise<void> {\r\n        if (this.privWebsocketClient) {\r\n            if (this.privConnectionState !== ConnectionState.Disconnected) {\r\n                this.privWebsocketClient.close(1000, reason ? reason : \"Normal closure by client\");\r\n            }\r\n        } else {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        return this.privDisconnectDeferral.promise;\r\n    }\r\n\r\n    public get events(): EventSource<ConnectionEvent> {\r\n        return this.privConnectionEvents;\r\n    }\r\n\r\n    private sendRawMessage(sendItem: ISendItem): Promise<void> {\r\n        try {\r\n            // indicates we are draining the queue and it came with no message;\r\n            if (!sendItem) {\r\n                return Promise.resolve();\r\n            }\r\n\r\n            this.onEvent(new ConnectionMessageSentEvent(this.privConnectionId, new Date().toISOString(), sendItem.Message));\r\n\r\n            // add a check for the ws readystate in order to stop the red console error 'WebSocket is already in CLOSING or CLOSED state' appearing\r\n            if (this.isWebsocketOpen) {\r\n                // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\r\n                this.privWebsocketClient.send(sendItem.RawWebsocketMessage.payload);\r\n            } else {\r\n                return Promise.reject(\"websocket send error: Websocket not ready \" + this.privConnectionId + \" \" + sendItem.Message.id + \" \" + new Error().stack);\r\n            }\r\n            return Promise.resolve();\r\n\r\n        } catch (e) {\r\n            return Promise.reject(`websocket send error: ${e as string}`);\r\n        }\r\n    }\r\n\r\n    private async onClose(code: number, reason: string): Promise<void> {\r\n        const closeReason = `Connection closed. ${code}: ${reason}`;\r\n        this.privConnectionState = ConnectionState.Disconnected;\r\n        this.privDisconnectDeferral.resolve();\r\n        await this.privReceivingMessageQueue.drainAndDispose((): void => {\r\n            // TODO: Events for these ?\r\n            // Logger.instance.onEvent(new LoggingEvent(LogType.Warning, null, `Failed to process received message. Reason: ${closeReason}, Message: ${JSON.stringify(pendingReceiveItem)}`));\r\n        }, closeReason);\r\n\r\n        await this.privSendMessageQueue.drainAndDispose((pendingSendItem: ISendItem): void => {\r\n            pendingSendItem.sendStatusDeferral.reject(closeReason);\r\n        }, closeReason);\r\n    }\r\n\r\n    private async processSendQueue(): Promise<void> {\r\n        while (true) {\r\n            const itemToSend: Promise<ISendItem> = this.privSendMessageQueue.dequeue();\r\n            const sendItem: ISendItem = await itemToSend;\r\n            // indicates we are draining the queue and it came with no message;\r\n            if (!sendItem) {\r\n                return;\r\n            }\r\n\r\n            try {\r\n                await this.sendRawMessage(sendItem);\r\n                sendItem.sendStatusDeferral.resolve();\r\n            } catch (sendError) {\r\n                sendItem.sendStatusDeferral.reject(sendError as string);\r\n            }\r\n        }\r\n    }\r\n\r\n    private onEvent(event: ConnectionEvent): void {\r\n        this.privConnectionEvents.onEvent(event);\r\n        Events.instance.onEvent(event);\r\n    }\r\n\r\n    private get isWebsocketOpen(): boolean {\r\n        return this.privWebsocketClient && this.privWebsocketClient.readyState === this.privWebsocketClient.OPEN;\r\n    }\r\n\r\n}\r\n"]}},"error":null,"hash":"2136b993580a802ca63bb0ff71cc6a69","cacheData":{"env":{}}}